stages:
  - build
  - deploy

build:
  image: golang:latest
  stage: build
  variables:
    GIT_STRATEGY: clone
  script:
    - go mod tidy -v
    - go get -v
    - go test -v -failfast -vet -all -race ./...
    - go build -v -o cf-www
  artifacts:
    paths:
      - cf.db
      - cf-www

deploy:
  image: alpine:latest
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - apk add openssh
    - mkdir ~/.ssh
    - eval $(ssh-agent -s)
    # TODO: replace bash with default alpine shell.
    # /bin/sh in place of bash fails with
    # /bin/sh: syntax error: unexpected "("
    - apk add bash
    - bash -c "ssh-add <(echo '$SSH_KEY')"
    - ssh-keyscan -v -H $SSH_DOMAIN >> ~/.ssh/known_hosts
    
    - ssh -v $SSH_USER@$SSH_DOMAIN systemctl stop cf-www
    - scp -v cf-www cf.db $SSH_USER@$SSH_DOMAIN:$SSH_PATH
    - ssh -v $SSH_USER@$SSH_DOMAIN systemctl start cf-www && systemctl status cf-www
  only:
    - master
